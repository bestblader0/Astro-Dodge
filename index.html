<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astro Dodge</title>
<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: sans-serif;
    overflow: hidden;
  }
  #gameCanvas { display: block; background: black; }
  #startScreen, #gameOverScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    text-align: center; z-index: 10;
  }
  button {
    padding: 12px 20px; margin: 10px; font-size: 18px;
  }
  #joystick {
    position: fixed; bottom: 60px; left: 60px;
    width: 180px; height: 180px;
    background: rgba(255,255,255,0.15);
    border-radius: 50%; touch-action: none;
  }
  #joystick-knob {
    position: absolute; top: 70px; left: 70px;
    width: 40px; height: 40px;
    background: rgba(255,255,255,0.8);
    border-radius: 50%; pointer-events: none;
  }
  #score {
    position: fixed; top: 10px; left: 10px;
    font-size: 20px; z-index: 5;
  }
  #shieldIcon {
    position: fixed; top: 10px; right: 10px;
    font-size: 20px; color: cyan; z-index: 5;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="score">Score: 0</div>
<div id="shieldIcon"></div>

<div id="startScreen">
  <h1>Astro Dodge</h1>
  <p>Move to avoid red asteroids.</p>
  <p>Collect blue squares to stack shields.</p>
  <p>Use joystick or arrow/WASD keys.</p>
  <div>
    <button onclick="startGame(2)">Easy</button>
    <button onclick="startGame(4)">Medium</button>
    <button onclick="startGame(6)">Hard</button>
  </div>
</div>

<div id="gameOverScreen" style="display:none;">
  <h1>Game Over</h1>
  <p id="finalScore"></p>
  <button onclick="showStart()">Restart</button>
</div>

<div id="joystick">
  <div id="joystick-knob"></div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let shipX, shipY, shipSize = 30;
let asteroids = [];
let powerups = [];
let score = 0;
let shields = 0; // now stackable
let asteroidSpeed = 2;
let gameRunning = false;

let joyActive = false, joyStartX = 0, joyStartY = 0, joyCurrentX = 0, joyCurrentY = 0;
const joystick = document.getElementById("joystick");
const knob = document.getElementById("joystick-knob");

joystick.addEventListener("touchstart", e => {
  joyActive = true;
  joyStartX = e.touches[0].clientX;
  joyStartY = e.touches[0].clientY;
  joyCurrentX = joyStartX;
  joyCurrentY = joyStartY;
});
joystick.addEventListener("touchmove", e => {
  joyCurrentX = e.touches[0].clientX;
  joyCurrentY = e.touches[0].clientY;
  let dx = joyCurrentX - joyStartX;
  let dy = joyCurrentY - joyStartY;
  let maxDist = 70;
  dx = Math.max(-maxDist, Math.min(maxDist, dx));
  dy = Math.max(-maxDist, Math.min(maxDist, dy));
  knob.style.left = (70 + dx) + "px";
  knob.style.top = (70 + dy) + "px";
});
joystick.addEventListener("touchend", () => {
  joyActive = false;
  knob.style.left = "70px";
  knob.style.top = "70px";
});

let keysPressed = {};
document.addEventListener("keydown", e => keysPressed[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keysPressed[e.key.toLowerCase()] = false);

function updateKeyboardMovement() {
  let step = 5;
  if (keysPressed["arrowleft"] || keysPressed["a"]) shipX -= step;
  if (keysPressed["arrowright"] || keysPressed["d"]) shipX += step;
  if (keysPressed["arrowup"] || keysPressed["w"]) shipY -= step;
  if (keysPressed["arrowdown"] || keysPressed["s"]) shipY += step;
  shipX = Math.max(0, Math.min(canvas.width - shipSize, shipX));
  shipY = Math.max(0, Math.min(canvas.height - shipSize, shipY));
}

function startGame(speed) {
  asteroidSpeed = speed;
  score = 0;
  shields = 0;
  shipX = canvas.width / 2 - shipSize / 2;
  shipY = canvas.height - shipSize - 20;
  asteroids = [];
  powerups = [];
  document.getElementById("startScreen").style.display = "none";
  document.getElementById("gameOverScreen").style.display = "none";
  gameRunning = true;
  loop();
}

function showStart() {
  document.getElementById("startScreen").style.display = "flex";
  document.getElementById("gameOverScreen").style.display = "none";
}

function spawnAsteroid() {
  let size = 20 + Math.random() * 20;
  asteroids.push({x: Math.random() * (canvas.width - size), y: -size, size});
}
function spawnPowerup() {
  let size = 20;
  powerups.push({x: Math.random() * (canvas.width - size), y: -size, size});
}

function update() {
  updateKeyboardMovement();

  if (joyActive) {
    let dx = joyCurrentX - joyStartX;
    let dy = joyCurrentY - joyStartY;
    let maxDist = 70;
    dx = Math.max(-maxDist, Math.min(maxDist, dx));
    dy = Math.max(-maxDist, Math.min(maxDist, dy));
    let normX = dx / maxDist;
    let normY = dy / maxDist;
    let topSpeed = 5;
    shipX += normX * topSpeed;
    shipY += normY * topSpeed;
    shipX = Math.max(0, Math.min(canvas.width - shipSize, shipX));
    shipY = Math.max(0, Math.min(canvas.height - shipSize, shipY));
  }

  if (Math.random() < 0.03) spawnAsteroid();
  if (Math.random() < 0.005) spawnPowerup();

  asteroids.forEach(a => a.y += asteroidSpeed);
  powerups.forEach(p => p.y += asteroidSpeed * 0.8);

  asteroids = asteroids.filter(a => {
    if (a.y > canvas.height) return false;
    if (a.x < shipX + shipSize && a.x + a.size > shipX &&
        a.y < shipY + shipSize && a.y + a.size > shipY) {
      if (shields > 0) {
        shields--;
        return false;
      } else {
        gameOver();
        return false;
      }
    }
    return true;
  });

  powerups = powerups.filter(p => {
    if (p.y > canvas.height) return false;
    if (p.x < shipX + shipSize && p.x + p.size > shipX &&
        p.y < shipY + shipSize && p.y + p.size > shipY) {
      shields++;
      return false;
    }
    return true;
  });

  score++;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.fillRect(shipX, shipY, shipSize, shipSize);

  ctx.fillStyle = "red";
  asteroids.forEach(a => ctx.fillRect(a.x, a.y, a.size, a.size));

  ctx.fillStyle = "cyan";
  powerups.forEach(p => ctx.fillRect(p.x, p.y, p.size, p.size));
}

function loop() {
  if (!gameRunning) return;
  update();
  draw();
  document.getElementById("score").innerText = "Score: " + score;
  document.getElementById("shieldIcon").innerText = shields > 0 ? "üõ°Ô∏è x" + shields : "";
  requestAnimationFrame(loop);
}

function gameOver() {
  gameRunning = false;
  document.getElementById("finalScore").innerText = "Final Score: " + score;
  document.getElementById("gameOverScreen").style.display = "flex";
}
</script>
</body>
</html>